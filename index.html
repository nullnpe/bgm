<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGM Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #fff;
            font-size: 24px;
        }

        .player-section {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .video-toggle {
            background: #363636;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .video-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .video-toggle label {
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }

        #player {
            width: 100%;
            height: 150px;
            background: #000;
            border-radius: 4px;
            margin-bottom: 10px;
            display: none;
        }

        #player.visible {
            display: block;
        }

        .progress-control {
            background: #363636;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #555;
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #0066cc, #0099ff);
            border-radius: 15px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            font-weight: 600;
            color: #e0e0e0;
        }

        .time-current {
            color: #0066cc;
        }

        .time-total {
            color: #aaa;
        }

        .loop-toggle {
            background: #363636;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loop-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .loop-toggle label {
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }

        .loop-control {
            background: #363636;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: none;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .loop-control.visible {
            display: flex;
        }

        .loop-control input[type="text"] {
            width: 60px;
            padding: 6px;
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #e0e0e0;
            text-align: center;
            font-size: 13px;
        }

        .loop-control label {
            font-size: 13px;
            color: #aaa;
        }

        .loop-control button {
            font-size: 12px;
            padding: 6px 12px;
        }

        .volume-control {
            background: #363636;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .volume-control label {
            font-size: 14px;
            font-weight: 600;
            min-width: 80px;
            color: #fff;
        }

        .volume-slider {
            flex: 1;
            height: 40px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #0066cc 0%, #0066cc 100%, #555 100%);
            border-radius: 20px;
            outline: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 50px;
            height: 50px;
            background: #fff;
            border: 4px solid #0066cc;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .volume-slider::-moz-range-thumb {
            width: 50px;
            height: 50px;
            background: #fff;
            border: 4px solid #0066cc;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .volume-value {
            font-size: 24px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            color: #0066cc;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        button:hover {
            background: #0052a3;
        }

        button.active {
            background: #00cc66;
        }

        button:disabled {
            cursor: not-allowed;
        }

        .now-playing {
            background: #363636;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .category-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .category-selector select {
            flex: 1;
            min-width: 150px;
            padding: 8px;
            background: #363636;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 13px;
        }

        .playlists-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .playlists-container.cols-1 {
            grid-template-columns: 1fr;
        }

        .playlists-container.cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .playlists-container.cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .playlists-container.cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        .playlist {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            overflow-y: auto;
            max-height: 500px;
        }

        .playlist h2 {
            margin-bottom: 12px;
            color: #fff;
            font-size: 16px;
            position: sticky;
            top: 0;
            background: #2a2a2a;
            padding-bottom: 8px;
            z-index: 1;
        }

        .song-item {
            background: #363636;
            padding: 10px;
            margin-bottom: 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
        }

        .song-item:hover {
            background: #404040;
        }

        .song-item.playing {
            background: #0066cc;
        }

        .song-title {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .song-meta {
            font-size: 11px;
            color: #aaa;
        }

        @media (max-width: 1200px) {
            .playlists-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .playlists-container {
                grid-template-columns: 1fr;
            }
            
            #player {
                height: 120px;
            }

            .volume-slider {
                height: 35px;
            }

            .volume-slider::-webkit-slider-thumb {
                width: 45px;
                height: 45px;
            }

            .volume-slider::-moz-range-thumb {
                width: 45px;
                height: 45px;
            }

            .volume-value {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ BGM Player</h1>

        <div class="player-section">
            <div class="video-toggle">
                <input type="checkbox" id="videoToggle" onchange="toggleVideoDisplay()">
                <label for="videoToggle">ğŸ“º ì˜ìƒë³´ê¸°</label>
            </div>
            
            <div id="player"></div>
            
            <div class="progress-control">
                <div class="progress-bar-container" onclick="seekToPosition(event)">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="time-display">
                    <span class="time-current" id="currentTime">0:00</span>
                    <span class="time-total" id="totalTime">0:00</span>
                </div>
            </div>

            <div class="loop-toggle">
                <input type="checkbox" id="loopToggle" onchange="toggleLoopUI()">
                <label for="loopToggle">ğŸ” êµ¬ê°„ë°˜ë³µ</label>
            </div>

            <div class="loop-control" id="loopControl">
                <label>ğŸ” êµ¬ê°„ë°˜ë³µ:</label>
                <label>ì‹œì‘</label>
                <input type="text" id="loopStart" placeholder="0:00" maxlength="5">
                <label>~</label>
                <label>ì¢…ë£Œ</label>
                <input type="text" id="loopEnd" placeholder="0:00" maxlength="5">
                <button id="loopBtn" onclick="toggleLoopSection()">êµ¬ê°„ë°˜ë³µ ì‹œì‘</button>
                <button onclick="setCurrentAsLoopStart()">í˜„ì¬â†’ì‹œì‘</button>
                <button onclick="setCurrentAsLoopEnd()">í˜„ì¬â†’ì¢…ë£Œ</button>
            </div>
            
            <div class="volume-control">
                <label>ğŸ”Š ìŒëŸ‰</label>
                <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="100" oninput="updateVolume(this.value)">
                <div class="volume-value" id="volumeValue">100</div>
            </div>
            
            <div class="now-playing" id="nowPlaying">ì¬ìƒ ì¤‘ì¸ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
            
            <div class="controls">
                <button id="playPauseBtn" onclick="togglePlayPause()">â¸ï¸ ì¼ì‹œì •ì§€</button>
                <button onclick="stopPlayer()">â¹ï¸ ì •ì§€</button>
                <button id="endingBtn3000" onclick="endingFadeOut(3000)" style="background: #cc0066;">ë§ˆë¬´ë¦¬ (3ì´ˆ)</button>
                <button id="endingBtn5000" onclick="endingFadeOut(5000)" style="background: #cc0066;">ë§ˆë¬´ë¦¬ (5ì´ˆ)</button>
                <button onclick="playPrevious()">â® ì´ì „</button>
                <button onclick="playNext()">â­ ë‹¤ìŒ</button>
                <button id="shuffleBtn" onclick="toggleShuffle()">ğŸ”€ ëœë¤</button>
                <button id="singleRepeatBtn" onclick="toggleSingleRepeat()">ğŸ”‚ í•œê³¡ë°˜ë³µ</button>
                <button id="repeatBtn" onclick="toggleRepeat()">ğŸ” ì—°ì†ì¬ìƒ</button>
                <button id="crossfadeBtn" onclick="toggleCrossfade()">ğŸšï¸ Fade Out</button>
                <label style="color: #aaa; font-size: 13px; margin-left: 10px;">
                    ë¦¬ìŠ¤íŠ¸ í‘œì‹œ: 
                    <select id="columnSelect" onchange="updateColumnCount()" style="width: auto; padding: 4px 8px; margin-left: 5px;">
                        <option value="1">1ê°œ</option>
                        <option value="2" selected>2ê°œ</option>
                        <option value="3">3ê°œ</option>
                        <option value="4">4ê°œ</option>
                    </select>
                </label>
            </div>
        </div>

        <div class="category-selector">
            <select id="categorySelect1" onchange="updatePlaylists()">
                <option value="">ì¹´í…Œê³ ë¦¬ 1</option>
            </select>
            <select id="categorySelect2" onchange="updatePlaylists()">
                <option value="">ì¹´í…Œê³ ë¦¬ 2</option>
            </select>
            <select id="categorySelect3" onchange="updatePlaylists()">
                <option value="">ì¹´í…Œê³ ë¦¬ 3</option>
            </select>
            <select id="categorySelect4" onchange="updatePlaylists()">
                <option value="">ì¹´í…Œê³ ë¦¬ 4</option>
            </select>
        </div>

        <div class="playlists-container cols-3" id="playlistsContainer">
            <div class="playlist" id="playlist1">
                <h2 id="playlist1Title">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
                <div id="playlist1Content"></div>
            </div>
            <div class="playlist" id="playlist2">
                <h2 id="playlist2Title">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
                <div id="playlist2Content"></div>
            </div>
            <div class="playlist" id="playlist3">
                <h2 id="playlist3Title">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
                <div id="playlist3Content"></div>
            </div>
            <div class="playlist" id="playlist4">
                <h2 id="playlist4Title">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
                <div id="playlist4Content"></div>
            </div>
        </div>
    </div>

    <script>
        let config = {
            "íš¨ê³¼": [
                {
                    "url": "https://youtu.be/-gDdjMsMznk?si=vh-9ZMThjKnSJ0hc&t=2",
                    "title": "ëƒ‰ì •ê³¼ ì—´ì • ì‚¬ì´ OST (The Whole Nine Yards)"
                }
                
            ],
            "BGM": [
                {
                    "url": "https://youtu.be/_fh133ZO1AE?si=u5xeoh1MEL4tDwrz",
                    "title": "Vince Guaraldi Trio - O Tannenbaum (5:05)"
                },
                {
                    "url": "https://youtu.be/tEm9EyEPMYM?si=YuVBflGaxqXUnmzP",
                    "title": "Jingle bell rock"
                },
                {
                    "url": "https://youtu.be/fBUQSyzHOss?si=L24_sFmYmkve0BlM",
                    "title": "Underneath the Tree"
                }
            ]
        };    

        let player;
        let currentSong = null;
        let playlist = [];
        let currentIndex = 0;
        let isShuffleMode = false;
        let isRepeatMode = false;
        let isSingleRepeatMode = false;
        let shuffledPlaylist = [];
        let isPlaying = false;
        let currentCategory = null;
        let isCrossfadeMode = false;
        let fadeOutInterval = null;
        let isEndingFadeOut = false;
        let progressUpdateInterval = null;
        let isLoopSectionMode = false;
        let loopStartTime = 0;
        let loopEndTime = 0;
        let loopCheckInterval = null;

        let tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        let firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '150',
                width: '100%',
                videoId: '',
                playerVars: {
                    'controls': 1,
                    'modestbranding': 1,
                    'rel': 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            updateCategorySelectors();
            updatePlaylists();
            updateColumnCount();
            startProgressUpdate();
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                isPlaying = true;
                updatePlayPauseButton();
                startProgressUpdate();
            } else if (event.data === YT.PlayerState.PAUSED) {
                isPlaying = false;
                updatePlayPauseButton();
            } else if (event.data === YT.PlayerState.ENDED) {
                isPlaying = false;
                updatePlayPauseButton();
                
                if (isSingleRepeatMode && currentSong) {
                    const videoId = extractVideoId(currentSong.url);
                    if (videoId && player) {
                        player.loadVideoById(videoId);
                    }
                } else if (isRepeatMode) {
                    playNext();
                }
            }
        }

        function toggleVideoDisplay() {
            const videoToggle = document.getElementById('videoToggle');
            const playerDiv = document.getElementById('player');
            
            if (videoToggle.checked) {
                playerDiv.classList.add('visible');
            } else {
                playerDiv.classList.remove('visible');
            }
        }

        function toggleLoopUI() {
            const loopToggle = document.getElementById('loopToggle');
            const loopControl = document.getElementById('loopControl');
            
            if (loopToggle.checked) {
                loopControl.classList.add('visible');
            } else {
                loopControl.classList.remove('visible');
                // ì²´í¬ í•´ì œ ì‹œ êµ¬ê°„ë°˜ë³µë„ ì¤‘ì§€
                if (isLoopSectionMode) {
                    toggleLoopSection();
                }
            }
        }

        function startProgressUpdate() {
            if (progressUpdateInterval) {
                clearInterval(progressUpdateInterval);
            }
            
            progressUpdateInterval = setInterval(() => {
                if (player && player.getCurrentTime && player.getDuration) {
                    try {
                        const currentTime = player.getCurrentTime();
                        const duration = player.getDuration();
                        
                        if (duration > 0) {
                            const percentage = (currentTime / duration) * 100;
                            document.getElementById('progressBar').style.width = percentage + '%';
                            document.getElementById('currentTime').textContent = formatTime(currentTime);
                            document.getElementById('totalTime').textContent = formatTime(duration);
                        }
                    } catch (e) {
                        // ì—ëŸ¬ ë¬´ì‹œ
                    }
                }
            }, 500);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        function parseTimeToSeconds(timeStr) {
            const parts = timeStr.split(':');
            if (parts.length !== 2) return 0;
            const mins = parseInt(parts[0]) || 0;
            const secs = parseInt(parts[1]) || 0;
            return mins * 60 + secs;
        }

        function toggleLoopSection() {
            isLoopSectionMode = !isLoopSectionMode;
            const loopBtn = document.getElementById('loopBtn');
            
            if (isLoopSectionMode) {
                const startStr = document.getElementById('loopStart').value;
                const endStr = document.getElementById('loopEnd').value;
                
                loopStartTime = parseTimeToSeconds(startStr);
                loopEndTime = parseTimeToSeconds(endStr);
                
                if (loopEndTime <= loopStartTime) {
                    alert('ì¢…ë£Œ ì‹œê°„ì´ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.');
                    isLoopSectionMode = false;
                    return;
                }
                
                loopBtn.textContent = 'êµ¬ê°„ë°˜ë³µ ì¤‘ì§€';
                loopBtn.classList.add('active');
                
                // ì‹œì‘ ìœ„ì¹˜ë¡œ ì´ë™
                if (player && player.seekTo) {
                    player.seekTo(loopStartTime, true);
                }
                
                // êµ¬ê°„ ì²´í¬ ì‹œì‘
                startLoopCheck();
            } else {
                loopBtn.textContent = 'êµ¬ê°„ë°˜ë³µ ì‹œì‘';
                loopBtn.classList.remove('active');
                stopLoopCheck();
            }
        }

        function startLoopCheck() {
            if (loopCheckInterval) {
                clearInterval(loopCheckInterval);
            }
            
            loopCheckInterval = setInterval(() => {
                if (player && player.getCurrentTime && isLoopSectionMode) {
                    const currentTime = player.getCurrentTime();
                    
                    // ì¢…ë£Œ ì‹œê°„ì„ ë„˜ì–´ê°€ë©´ ì‹œì‘ ìœ„ì¹˜ë¡œ ì´ë™
                    if (currentTime >= loopEndTime) {
                        player.seekTo(loopStartTime, true);
                    }
                }
            }, 100); // 0.1ì´ˆë§ˆë‹¤ ì²´í¬ (ë”œë ˆì´ ìµœì†Œí™”)
        }

        function stopLoopCheck() {
            if (loopCheckInterval) {
                clearInterval(loopCheckInterval);
                loopCheckInterval = null;
            }
        }

        function setCurrentAsLoopStart() {
            if (player && player.getCurrentTime) {
                const currentTime = player.getCurrentTime();
                document.getElementById('loopStart').value = formatTime(currentTime);
            }
        }

        function setCurrentAsLoopEnd() {
            if (player && player.getCurrentTime) {
                const currentTime = player.getCurrentTime();
                document.getElementById('loopEnd').value = formatTime(currentTime);
            }
        }

        function seekToPosition(event) {
            if (!player || !player.getDuration || !player.seekTo) return;
            
            const container = event.currentTarget;
            const rect = container.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = clickX / rect.width;
            const duration = player.getDuration();
            
            if (duration > 0) {
                const seekTime = duration * percentage;
                player.seekTo(seekTime, true);
            }
        }

        function togglePlayPause() {
            if (!player || !player.getPlayerState) return;
            
            const state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING) {
                // ì¬ìƒ ì¤‘ì¼ ë•Œë§Œ Fade Out ì ìš©
                if (isCrossfadeMode && isPlaying) {
                    fadeOutAndPause();
                } else {
                    player.pauseVideo();
                }
            } else {
                player.playVideo();
            }
        }


        function fadeOutAndPause() {
            const originalVolume = player.getVolume();
            let currentVolume = originalVolume;
            
            if (fadeOutInterval) {
                clearInterval(fadeOutInterval);
            }
            
            fadeOutInterval = setInterval(() => {
                currentVolume -= 5;
                if (currentVolume <= 0) {
                    clearInterval(fadeOutInterval);
                    fadeOutInterval = null;
                    player.pauseVideo();
                    player.setVolume(originalVolume);
                    updateVolumeSlider(originalVolume);
                } else {
                    player.setVolume(currentVolume);
                    updateVolumeSlider(Math.round(currentVolume));
                }
            }, 50);
        }

        function fadeOutAndStop() {
            const originalVolume = player.getVolume();
            let currentVolume = originalVolume;
            
            if (fadeOutInterval) {
                clearInterval(fadeOutInterval);
            }
            
            fadeOutInterval = setInterval(() => {
                currentVolume -= 5;
                if (currentVolume <= 0) {
                    clearInterval(fadeOutInterval);
                    fadeOutInterval = null;
                    player.stopVideo();
                    player.setVolume(originalVolume);
                    updateVolumeSlider(originalVolume);
                    isPlaying = false;
                    updatePlayPauseButton();
                } else {
                    player.setVolume(currentVolume);
                    updateVolumeSlider(Math.round(currentVolume));
                }
            }, 50);
        }

        function stopPlayer() {
            if (!player || !player.stopVideo) return;
            
            // ì¬ìƒ ì¤‘ì´ê³  Crossfade ëª¨ë“œì¼ ë•Œë§Œ Fade Out ì ìš©
            if (isCrossfadeMode && isPlaying) {
                fadeOutAndStop();
            } else {
                // ê¸°ì¡´ Fade Outì´ ì§„í–‰ ì¤‘ì´ë©´ ì·¨ì†Œ
                if (fadeOutInterval) {
                    clearInterval(fadeOutInterval);
                    fadeOutInterval = null;
                    const currentVolume = document.getElementById('volumeSlider').value;
                    if (player.setVolume) {
                        player.setVolume(currentVolume);
                    }
                }
                
                player.stopVideo();
                isPlaying = false;
                updatePlayPauseButton();
            }
        }

        function endingFadeOut(durationSecond) {
            if (!player || !player.getVolume || !isPlaying) return;
            
            if (isEndingFadeOut) return;
            
            isEndingFadeOut = true;
            let endingBtn = document.getElementById('endingBtn' + durationSecond);
            endingBtn.disabled = true;
            endingBtn.style.opacity = '0.5';
            endingBtn.textContent = 'ğŸ¬ ë§ˆë¬´ë¦¬ ì¤‘...';
            
            const originalVolume = player.getVolume();
            let currentVolume = originalVolume;
            const steps = 100;
            const duration = durationSecond;
            const intervalTime = duration / steps;
            const volumeDecrement = originalVolume / steps;
            let _textContent = duration/1000;
            
            if (fadeOutInterval) {
                clearInterval(fadeOutInterval);
            }
            
            fadeOutInterval = setInterval(() => {
                currentVolume -= volumeDecrement;
                if (currentVolume <= 0) {
                    clearInterval(fadeOutInterval);
                    fadeOutInterval = null;
                    player.stopVideo();
                    player.setVolume(originalVolume);
                    updateVolumeSlider(originalVolume);
                    isPlaying = false;
                    isEndingFadeOut = false;
                    updatePlayPauseButton();
                    
                    endingBtn.disabled = false;
                    endingBtn.style.opacity = '1';
                    endingBtn.textContent = 'ğŸ¬ ë§ˆë¬´ë¦¬ (' + _textContent +'ì´ˆ)';
                } else {
                    player.setVolume(Math.max(0, currentVolume));
                    updateVolumeSlider(Math.round(currentVolume));
                }
            }, intervalTime);
        }

        function updateVolumeSlider(value) {
            const slider = document.getElementById('volumeSlider');
            const valueDisplay = document.getElementById('volumeValue');
            if (slider && valueDisplay) {
                slider.value = value;
                valueDisplay.textContent = value;
                const percentage = value;
                slider.style.background = `linear-gradient(to right, #0066cc 0%, #0066cc ${percentage}%, #555 ${percentage}%)`;
            }
        }

        function updateVolume(value) {
            if (player && player.setVolume) {
                player.setVolume(value);
            }
            document.getElementById('volumeValue').textContent = value;
            
            const slider = document.getElementById('volumeSlider');
            const percentage = value;
            slider.style.background = `linear-gradient(to right, #0066cc 0%, #0066cc ${percentage}%, #555 ${percentage}%)`;
        }

        function updatePlayPauseButton() {
            const btn = document.getElementById('playPauseBtn');
            if (isPlaying) {
                btn.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
            } else {
                btn.textContent = 'â–¶ï¸ ì¬ìƒ';
            }
        }

        function extractVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        function playSong(song, categoryName) {
            const videoId = extractVideoId(song.url);
            if (!videoId || !player || !player.loadVideoById) return;

            if (isCrossfadeMode && isPlaying && player.getVolume) {
                const originalVolume = player.getVolume();
                let currentVolume = originalVolume;
                
                if (fadeOutInterval) {
                    clearInterval(fadeOutInterval);
                }
                
                fadeOutInterval = setInterval(() => {
                    currentVolume -= 5;
                    if (currentVolume <= 0) {
                        clearInterval(fadeOutInterval);
                        fadeOutInterval = null;
                        player.setVolume(originalVolume);
                        updateVolumeSlider(originalVolume);
                        loadAndPlayNewSong(song, categoryName, videoId);
                    } else {
                        player.setVolume(currentVolume);
                        updateVolumeSlider(Math.round(currentVolume));
                    }
                }, 50);
            } else {
                loadAndPlayNewSong(song, categoryName, videoId);
            }
        }

        function loadAndPlayNewSong(song, categoryName, videoId) {
            currentSong = { ...song, category: categoryName };
            currentCategory = categoryName;
            player.loadVideoById(videoId);
            isPlaying = true;
            updateNowPlaying();
            updatePlayingIndicator();
            updatePlayPauseButton();
        }

        function toggleCrossfade() {
            isCrossfadeMode = !isCrossfadeMode;
            document.getElementById('crossfadeBtn').classList.toggle('active', isCrossfadeMode);
        }

        function toggleSingleRepeat() {
            isSingleRepeatMode = !isSingleRepeatMode;
            document.getElementById('singleRepeatBtn').classList.toggle('active', isSingleRepeatMode);
            
            if (isSingleRepeatMode && isRepeatMode) {
                isRepeatMode = false;
                document.getElementById('repeatBtn').classList.remove('active');
            }
        }

        function updateNowPlaying() {
            if (!currentSong) {
                document.getElementById('nowPlaying').innerHTML = 'ì¬ìƒ ì¤‘ì¸ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤';
                return;
            }

            const displayName = currentSong.customName || currentSong.title;
            const tags = currentSong.tags ? currentSong.tags.join(', ') : '';
            document.getElementById('nowPlaying').innerHTML = `
                <strong>ì¬ìƒ ì¤‘:</strong> ${displayName}<br>
                ${tags ? `<small>ğŸ·ï¸ ${tags}</small>` : ''}
                ${currentSong.memo ? `<br><small>ğŸ“ ${currentSong.memo}</small>` : ''}
            `;
        }

        function updatePlayingIndicator() {
            document.querySelectorAll('.song-item').forEach(item => {
                item.classList.remove('playing');
            });
            
            if (currentSong) {
                const items = document.querySelectorAll(`[data-url="${currentSong.url}"]`);
                items.forEach(item => item.classList.add('playing'));
            }
        }

        function buildPlaylistFromCategories() {
            playlist = [];
            const cat1 = document.getElementById('categorySelect1').value;
            const cat2 = document.getElementById('categorySelect2').value;
            const cat3 = document.getElementById('categorySelect3').value;
            const cat4 = document.getElementById('categorySelect4').value;
            
            [cat1, cat2, cat3, cat4].forEach((cat, idx) => {
                if (cat && config[cat]) {
                    const otherCats = [cat1, cat2, cat3, cat4].filter((c, i) => i !== idx);
                    if (!otherCats.includes(cat)) {
                        config[cat].forEach(song => {
                            playlist.push({ ...song, category: cat });
                        });
                    }
                }
            });
            
            if (isShuffleMode) {
                shufflePlaylist();
            }
        }

        function shufflePlaylist() {
            if (currentCategory && config[currentCategory]) {
                shuffledPlaylist = config[currentCategory].map(song => ({
                    ...song,
                    category: currentCategory
                }));
            } else {
                shuffledPlaylist = [...playlist];
            }
            
            for (let i = shuffledPlaylist.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledPlaylist[i], shuffledPlaylist[j]] = [shuffledPlaylist[j], shuffledPlaylist[i]];
            }
        }

        function getActivePlaylist() {
            return isShuffleMode ? shuffledPlaylist : playlist;
        }

        function playNext() {
            buildPlaylistFromCategories();
            const activeList = getActivePlaylist();
            
            if (activeList.length === 0) return;
            
            if (currentSong) {
                const currentIdx = activeList.findIndex(s => s.url === currentSong.url);
                currentIndex = currentIdx >= 0 ? (currentIdx + 1) % activeList.length : 0;
            }
            
            playSong(activeList[currentIndex], activeList[currentIndex].category);
        }

        function playPrevious() {
            buildPlaylistFromCategories();
            const activeList = getActivePlaylist();
            
            if (activeList.length === 0) return;
            
            if (currentSong) {
                const currentIdx = activeList.findIndex(s => s.url === currentSong.url);
                currentIndex = currentIdx >= 0 ? (currentIdx - 1 + activeList.length) % activeList.length : 0;
            }
            
            playSong(activeList[currentIndex], activeList[currentIndex].category);
        }

        function toggleShuffle() {
            isShuffleMode = !isShuffleMode;
            document.getElementById('shuffleBtn').classList.toggle('active', isShuffleMode);
            if (isShuffleMode) {
                shufflePlaylist();
            }
        }

        function toggleRepeat() {
            isRepeatMode = !isRepeatMode;
            document.getElementById('repeatBtn').classList.toggle('active', isRepeatMode);
            
            if (isRepeatMode && isSingleRepeatMode) {
                isSingleRepeatMode = false;
                document.getElementById('singleRepeatBtn').classList.remove('active');
            }
        }

        function updateCategorySelectors() {
            const categories = Object.keys(config);
            const selects = [
                document.getElementById('categorySelect1'),
                document.getElementById('categorySelect2'),
                document.getElementById('categorySelect3'),
                document.getElementById('categorySelect4')
            ];
            
            const currentVals = selects.map(s => s.value);
            
            selects.forEach((select, idx) => {
                select.innerHTML = `<option value="">ì¹´í…Œê³ ë¦¬ ${idx + 1} ì„ íƒ</option>`;
                categories.forEach(cat => {
                    select.innerHTML += `<option value="${cat}" ${cat === currentVals[idx] ? 'selected' : ''}>${cat}</option>`;
                });
            });
        }

        function updatePlaylists() {
            const cat1 = document.getElementById('categorySelect1').value;
            const cat2 = document.getElementById('categorySelect2').value;
            const cat3 = document.getElementById('categorySelect3').value;
            const cat4 = document.getElementById('categorySelect4').value;
            
            updatePlaylist('playlist1', cat1);
            updatePlaylist('playlist2', cat2);
            updatePlaylist('playlist3', cat3);
            updatePlaylist('playlist4', cat4);
            buildPlaylistFromCategories();
        }

        function updateColumnCount() {
            const columnCount = document.getElementById('columnSelect').value;
            const container = document.getElementById('playlistsContainer');
            
            container.className = 'playlists-container cols-' + columnCount;
            
            for (let i = 1; i <= 4; i++) {
                const playlist = document.getElementById('playlist' + i);
                const select = document.getElementById('categorySelect' + i);
                
                if (i <= columnCount) {
                    playlist.style.display = 'block';
                    select.style.display = 'block';
                } else {
                    playlist.style.display = 'none';
                    select.style.display = 'none';
                }
            }
        }

        function updatePlaylist(playlistId, categoryName) {
            const titleEl = document.getElementById(playlistId + 'Title');
            const contentEl = document.getElementById(playlistId + 'Content');
            
            if (!categoryName || !config[categoryName]) {
                titleEl.textContent = 'ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”';
                contentEl.innerHTML = '';
                return;
            }
            
            titleEl.textContent = `${categoryName} (${config[categoryName].length}ê³¡)`;
            
            contentEl.innerHTML = config[categoryName].map(song => {
                const displayName = song.customName || song.title;
                const tags = song.tags ? song.tags.join(', ') : '';
                return `
                    <div class="song-item" data-url="${song.url}" onclick='playSong(${JSON.stringify(song).replace(/'/g, "&#39;")}, "${categoryName}")'>
                        <div class="song-title">${displayName}</div>
                        <div class="song-meta">
                            ${tags ? `ğŸ·ï¸ ${tags}` : ''}
                            ${song.memo ? ` | ğŸ“ ${song.memo}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            updatePlayingIndicator();
        }
    </script>
</body>
</html>
